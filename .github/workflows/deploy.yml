name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # ======================
      # 1. Checkout
      # ======================
      - name: Checkout repository
        uses: actions/checkout@v4

      # ======================
      # 2. Setup SSH
      # ======================
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      # ======================
      # 3. Copy project to EC2
      # ======================
      - name: Copy project to EC2
        run: |
          rsync -avz --delete \
            --exclude=".git" \
            ./ ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/home/ubuntu/app

      # ======================
      # 4. Deploy with Docker Compose
      # ======================
      - name: Deploy containers
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            cd /home/ubuntu/app/infra
            docker compose down
            docker compose up -d --build
          EOF

      # ======================
      # 5. Smoke Test
      # ======================
      - name: Smoke test backend
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
          "curl -f http://localhost:3001 || exit 1"

      # ======================
      # 6. Notify Discord
      # ======================
      - name: Notify Discord
        if: always()
        run: |
          STATUS="${{ job.status }}"
          curl -H "Content-Type: application/json" \
            -d "{
              \"content\": \"ðŸš€ **Deploy $STATUS**\nðŸ“¦ Repo: ${{ github.repository }}\nðŸ‘¤ Autor: ${{ github.actor }}\nðŸ”— Commit: https://github.com/${{ github.repository }}/commit/${{ github.sha }}\"
            }" \
            ${{ secrets.DISCORD_WEBHOOK_URL }}
